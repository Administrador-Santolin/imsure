<form [formGroup]="apoliceForm" (ngSubmit)="onSubmit()">
  <fieldset class="form-grid">
    <legend>
      <h2>Dados da Apólice</h2>
    </legend>

    <mat-form-field appearance="outline" class="span-4">
      <mat-label>Cliente</mat-label>
      <input matInput placeholder="Digite o nome do cliente" [formControl]="clienteSearchControl"
        [matAutocomplete]="autoCliente" required />
      <mat-autocomplete #autoCliente="matAutocomplete" [displayWith]="displayCliente">
        @if ( filteredClientes$ | async; as clientes ) {
        @if ( clientes.length === 0 && clienteSearchControl.value ) {
        <mat-option value="">
          Nenhum cliente encontrado
        </mat-option>
        }

        @for (cliente of clientes; track cliente.id) {
        <mat-option [value]="cliente" (onSelectionChange)="onClienteSelected($event)">
          {{ cliente.nome }} - {{ cliente.cpf | mascara: '000.000.000-00' }}
        </mat-option>
        }
        } @else {
        <mat-option value="" disabled>Carregando clientes...</mat-option>
        }

      </mat-autocomplete>
      <input type="hidden" formControlName="clienteId">
      <input type="hidden" formControlName="clienteNome">
      @if ( apoliceForm.get('clienteId')?.hasError('required') && apoliceForm.get('clienteId')?.touched ) {
      <mat-error>
        Cliente é obrigatório.
      </mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline" class="span-3">
      <mat-label>Apólice</mat-label>
      <input matInput placeholder="Número da apólice" formControlName="apolice" required />
      @if ( apoliceForm.get('apolice')?.hasError('required') && apoliceForm.get('apolice')?.touched ) {
      <mat-error>
        Número da apólice é obrigatório.
      </mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline" class="span-3">
      <mat-label>Proposta</mat-label>
      <input matInput placeholder="Número da proposta" formControlName="proposta" required />
      @if ( apoliceForm.get('proposta')?.hasError('required') && apoliceForm.get('proposta')?.touched ) {
      <mat-error>
        Número da proposta é obrigatório.
      </mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline" class="span-3">
      <mat-label>Seguradora</mat-label>
      <mat-select formControlName="seguradora" required>
        <mat-option value="Yelum">Yelum</mat-option>
        <mat-option value="Porto Seguro">Porto Seguro</mat-option>
        <mat-option value="HDI">HDI</mat-option>
        <mat-option value="Mapfre">Mapfre</mat-option>
        <mat-option value="Bradesco">Bradesco</mat-option>
        <mat-option value="Itaú">Itaú</mat-option>
        <mat-option value="Zurich">Zurich</mat-option>
        <mat-option value="Tokio Marine">Tokio Marine</mat-option>
        <mat-option value="Allianz">Allianz</mat-option>
      </mat-select>
      @if ( apoliceForm.get('seguradora')?.hasError('required') && apoliceForm.get('seguradora')?.touched ) {
      <mat-error>
        Seguradora é obrigatória.
      </mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline" class="span-2">
      <mat-label>Produto</mat-label>
      <mat-select formControlName="produto" required>
        <mat-option value="Automóvel">Automóvel</mat-option>
        <mat-option value="Residencial">Residencial</mat-option>
        <mat-option value="Vida">Vida</mat-option>
        <mat-option value="Saúde">Saúde</mat-option>
        <mat-option value="Empresarial">Empresarial</mat-option>
        <mat-option value="Rural">Rural</mat-option>
        <mat-option value="Odonto">Odonto</mat-option>
        <mat-option value="Viagem">Viagem</mat-option>
        <mat-option value="Fiança Locatícia">Fiança Locatícia</mat-option>
        <mat-option value="Responsabilidade Civil">Responsabilidade Civil</mat-option>
        <mat-option value="Transportes">Transportes</mat-option>
        <mat-option value="Outros">Outros</mat-option>
      </mat-select>
      @if ( apoliceForm.get('produto')?.hasError('required') && apoliceForm.get('produto')?.touched ) {
      <mat-error>
        Produto é obrigatório.
      </mat-error>
      }

    </mat-form-field>

    <mat-form-field appearance="outline" class="span-2">
      <mat-label>Sub-tipo do documento</mat-label>
      <mat-select formControlName="subTipoDocumento" required>
        <mat-option value="Renovavel">Renovável</mat-option>
        <mat-option value="Avulso">Avulso</mat-option>
      </mat-select>
      @if ( apoliceForm.get('subTipoDocumento')?.hasError('required') && apoliceForm.get('subTipoDocumento')?.touched) {
      <mat-error>
        Sub-tipo é obrigatório.
      </mat-error>
      }
    </mat-form-field>

    <div class="form-grid-child span-12">
      <mat-form-field appearance="outline" class="span-2">
        <mat-label>Início de Vigência</mat-label>
        <input matInput [matDatepicker]="inicioVigenciaPicker" placeholder="Início de vigência"
          formControlName="inicioVigencia" required>
        <mat-datepicker-toggle matIconSuffix [for]="inicioVigenciaPicker"></mat-datepicker-toggle>
        <mat-datepicker #inicioVigenciaPicker></mat-datepicker>
        @if ( apoliceForm.get('inicioVigencia')?.hasError('required') && apoliceForm.get('inicioVigencia')?.touched ) {
        <mat-error>
          Início de Vigência é obrigatório.
        </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="span-2">
        <mat-label>Fim de Vigência</mat-label>
        <input matInput [matDatepicker]="fimVigenciaPicker" placeholder="Fim de vigência" formControlName="fimVigencia"
          required>
        <mat-datepicker-toggle matIconSuffix [for]="fimVigenciaPicker"></mat-datepicker-toggle>
        <mat-datepicker #fimVigenciaPicker></mat-datepicker>
        @if ( apoliceForm.get('fimVigencia')?.hasError('required') && apoliceForm.get('fimVigencia')?.touched ) {
        <mat-error>
          Fim de Vigência é obrigatório.
        </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="span-2">
        <mat-label>Data de Emissão</mat-label>
        <input matInput [matDatepicker]="emissaoPicker" placeholder="Data de Emissão" formControlName="dataEmissao"
          required>
        <mat-datepicker-toggle matIconSuffix [for]="emissaoPicker"></mat-datepicker-toggle>
        <mat-datepicker #emissaoPicker></mat-datepicker>
        @if ( apoliceForm.get('dataEmissao')?.hasError('required') && apoliceForm.get('dataEmissao')?.touched ) {
        <mat-error>
          Data de Emissão é obrigatória.
        </mat-error>
        }
      </mat-form-field>
    </div>

    <fieldset class="span-6 radioGroup">
      <legend>Tipo de Seguro</legend>
      <mat-radio-group aria-label="Tipo de Seguro" formControlName="tipoSeguro" required>
        <mat-radio-button value="novo">Novo</mat-radio-button>
        <mat-radio-button value="renovacao">Renovação</mat-radio-button>
        <mat-radio-button value="renovacaoOutra">Renovação de outra corretora</mat-radio-button>
      </mat-radio-group>
      @if ( apoliceForm.get('tipoSeguro')?.hasError('required') && apoliceForm.get('tipoSeguro')?.touched ) {
      <mat-error>
        Tipo de Seguro é obrigatório.
      </mat-error>
      }
    </fieldset>

    <fieldset class="span-6 radioGroup">
      <legend>Situação</legend>
      <mat-radio-group aria-label="Situação" formControlName="situacao" required>
        <mat-radio-button value="ativo">Ativo</mat-radio-button>
        <mat-radio-button value="vencido">Vencido</mat-radio-button>
        <mat-radio-button value="cancelado">Cancelado</mat-radio-button>
        <mat-radio-button value="pendente">Pendente</mat-radio-button>
        <mat-radio-button value="suspenso">Suspenso</mat-radio-button>
        <mat-radio-button value="naoRenovado">Não Renovado</mat-radio-button>
      </mat-radio-group>
      @if ( apoliceForm.get('situacao')?.hasError('required') && apoliceForm.get('situacao')?.touched ) {
      <mat-error>
        Situação é obrigatória.
      </mat-error>
      }
    </fieldset>

  </fieldset>

  <mat-accordion>
    <mat-expansion-panel formGroupName="informacoesFinanceiras">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>attach_money</mat-icon>
          Informações Financeiras
        </mat-panel-title>
      </mat-expansion-panel-header>

      <section class="form-grid">
        <fieldset class="span-4">
          <mat-form-field appearance="outline" class="span-4">
            <mat-label>Forma de Pagamento</mat-label>
            <mat-select formControlName="formaPagamento" required>
              <mat-option value="creditCard">Cartão de crédito</mat-option>
              <mat-option value="debit">Débito em conta</mat-option>
              <mat-option value="ticket">Boleto</mat-option>
              <mat-option value="pix">Pix</mat-option>
            </mat-select>
            @if ( getControl('informacoesFinanceiras', 'formaPagamento').hasError('required') &&
            getControl('informacoesFinanceiras', 'formaPagamento').touched ) {
            <mat-error>
              Forma de Pagamento é obrigatória.
            </mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="span-2">
            <mat-label>Parcelas</mat-label>
            <input matInput type="number" placeholder="Número de Parcelas" formControlName="parcelas" min="1"
              required />
            @if ( getControl('informacoesFinanceiras', 'parcelas').hasError('required') &&
            getControl('informacoesFinanceiras', 'parcelas').touched ) {
            <mat-error>
              Parcelas é obrigatório.
            </mat-error>
            } @else if ( getControl('informacoesFinanceiras', 'parcelas').hasError('min') &&
            getControl('informacoesFinanceiras', 'parcelas').touched ) {
            <mat-error>
              Mínimo 1 parcela.
            </mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="span-2">
            <mat-label>Vencimento da 1ª parcela</mat-label>
            <input matInput [matDatepicker]="vencimentoPrimeiraParcelaPicker" placeholder="Vencimento da 1ª parcela"
              formControlName="vencimentoPrimeiraParcela" required>
            <mat-datepicker-toggle matIconSuffix [for]="vencimentoPrimeiraParcelaPicker"></mat-datepicker-toggle>
            <mat-datepicker #vencimentoPrimeiraParcelaPicker></mat-datepicker>
            @if ( getControl('informacoesFinanceiras', 'vencimentoPrimeiraParcela').hasError('required') &&
            getControl('informacoesFinanceiras', 'vencimentoPrimeiraParcela').touched ) {
            <mat-error>
              Vencimento é obrigatório.
            </mat-error>
            }
          </mat-form-field>
        </fieldset>

        <fieldset class="inline-grid">
          <mat-form-field floatLabel="always" appearance="outline">
            <mat-label>Comissão</mat-label>
            <input matInput type="number" style="text-align: right;" formControlName="comissaoPercentual" min="0"
              max="100" />
            <span matTextSuffix>%</span>
            @if ( getControl('informacoesFinanceiras', 'comissaoPercentual').hasError('min') ||
            getControl('informacoesFinanceiras', 'comissaoPercentual').hasError('max') &&
            getControl('informacoesFinanceiras', 'comissaoPercentual').touched) {
            <mat-error>
              Deve ser entre 0 e 100.
            </mat-error>
            }
          </mat-form-field>

          <mat-form-field floatLabel="always" appearance="outline">
            <mat-label>Prêmio Líquido</mat-label>
            <input matInput type="text" formControlName="premioLiquido" min="0" mask="separator.2" thousandSeparator="."
              [decimalMarker]="','" />
            <span matTextPrefix>R$</span>
            @if ( getControl('informacoesFinanceiras', 'premioLiquido').hasError('min') &&
            getControl('informacoesFinanceiras', 'premioLiquido').touched) {
            <mat-error>
              Prêmio líquido deve ser positivo.
            </mat-error>
            }
          </mat-form-field>

          <mat-form-field floatLabel="always" appearance="outline">
            <mat-label>IOF</mat-label>
            <input matInput type="text" style="text-align: right;" formControlName="iofPercentual" min="0" max="100"
              [decimalMarker]="','" mask="percent.2" />
            <span matTextSuffix>%</span>
            @if ( getControl('informacoesFinanceiras', 'iofPercentual').hasError('min') ||
            getControl('informacoesFinanceiras', 'iofPercentual').hasError('max') &&
            getControl('informacoesFinanceiras', 'iofPercentual').touched ) {
            <mat-error>
              Deve ser entre 0 e 100.
            </mat-error>
            }
          </mat-form-field>

          <mat-form-field floatLabel="always" appearance="outline">
            <mat-label>Prêmio Total</mat-label>
            <input matInput type="text" formControlName="premioTotal" min="0" mask="separator.2" thousandSeparator="."
              [decimalMarker]="','" />
            <span matTextPrefix>R$</span>
            @if ( getControl('informacoesFinanceiras', 'premioTotal').hasError('min') &&
            getControl('informacoesFinanceiras', 'premioTotal').touched ) {
            <mat-error>
              Prêmio total deve ser positivo.
            </mat-error>
            }

          </mat-form-field>
        </fieldset>
      </section>
    </mat-expansion-panel>

    <div class="form-actions" style="margin: 1rem 0;">
      <button mat-raised-button color="primary" type="button" (click)="addItem()">
        Adicionar item segurado
      </button>
    </div>

    <!-- Lista de itens segurados -->
    @for ( item of itensSegurados.controls; let i = $index; track item.value?.id) {
    <mat-expansion-panel [formGroup]="$any(item)">  

      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>assignment</mat-icon>
          Item Segurado #{{ i + 1 }}
        </mat-panel-title>
        <mat-panel-description>
          Produto: {{ item.value?.produto || 'defina' }}
        </mat-panel-description>
      </mat-expansion-panel-header>

      <!-- Produto por item -->
      <mat-form-field appearance="outline" class="span-3">
        <mat-label>Produto do item</mat-label>
        <mat-select formControlName="produto">
          <mat-option value="Automóvel">Automóvel</mat-option>
          <mat-option value="Residencial">Residencial</mat-option>
          <mat-option value="Responsabilidade Civil">Responsabilidade Civil</mat-option>
          <!-- adicione outros aqui quando precisar -->
        </mat-select>
      </mat-form-field>

      <!-- Área para o form específico do item (próximo passo será ligar via CVA) -->
      @switch (item.get('produto')?.value) {
      @case ('Automóvel') {
      <!-- depois: <app-automovel formControlName="details"></app-automovel> -->
      <pre class="p-2 bg-light">Automóvel (placeholder). Details: {{ item.value?.details | json }}</pre>
      }
      @case ('Residencial') {
      <!-- depois: <app-locais formControlName="details"></app-locais> -->
      <pre class="p-2 bg-light">Residencial (placeholder). Details: {{ item.value?.details | json }}</pre>
      <app-locais></app-locais>
      }
      @case ('Responsabilidade Civil') {
      <!-- depois: <app-resp-civil formControlName="details"></app-resp-civil> -->
      <pre class="p-2 bg-light">Resp. Civil (placeholder). Details: {{ item.value?.details | json }}</pre>
      <app-resp-civil></app-resp-civil>
      }
      @default {
      <div class="p-2">Escolha um produto para este item.</div>
      }
      }

      <div class="form-actions" style="display:flex; gap:.5rem; margin-top:.5rem;">
        <button mat-stroked-button color="primary" type="button" (click)="cloneItem(i)">Duplicar item</button>
        <button mat-stroked-button color="warn" type="button" (click)="removeItem(i)">Remover item</button>
      </div>
    </mat-expansion-panel>
    }
  </mat-accordion>

  <div class="form-actions">
    <button matFab color="primary" type="submit" [disabled]="apoliceForm.invalid">Salvar Apólice</button>
    <button mat-button type="button" (click)="onCancel()">Cancelar</button>
  </div>
</form>


<!-- <mat-expansion-panel formGroupName="itemSegurado">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>assignment</mat-icon>
          Item Segurado
        </mat-panel-title>
      </mat-expansion-panel-header>

      @if ( apoliceForm.get('produto')?.value === 'Automóvel' ) {
      <app-automovel></app-automovel>
      } @else if ( isProdutoLocais() ){
      <app-locais></app-locais>
      } @else if ( apoliceForm.get('produto')?.value === 'Responsabilidade Civil' ) {
      <app-resp-civil></app-resp-civil>
      }

    </mat-expansion-panel>
  </mat-accordion> -->